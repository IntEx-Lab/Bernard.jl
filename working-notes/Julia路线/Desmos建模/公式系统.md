# Desmos 公式系统建模

本文档详细描述对 Desmos 公式系统的建模研究。由于 Desmos 并未开源，这些建模基于观察和推测，旨在为 ExprBuild 项目提供准确的设计基础。

## 基本术语定义

在 ExprBuild 中，我们对 Desmos 相关术语做出以下区分：

- **公式（Formula）**：指 Desmos 中的一行可编辑内容，包括变量定义、函数定义、方程等各种类型。Desmos 官方称之为"表达式"（Expression），但我们采用"公式"这一更广义的术语。

- **表达式（Expression）**：指可求值的数学表达式，是公式的一个子类型。

- **Expr**：在文档和代码里尽量用这个缩写来指代Julia语言的表达式概念，方便讨论和使用Julia语言的宏和元编程能力。

## 公式类型系统

Desmos 支持以下几种主要公式类型：

1. **表达式（Expression）**：
   - 形式：`2 + a`（其中 a 为已定义变量）
   - 特点：可以求值，但不定义任何新符号
   - 图形表现：不绘制任何图形，仅显示计算结果

2. **变量定义（Variable Definition）**：
   - 形式：`a = 3`
   - 特点：定义一个变量并占用该符号
   - 注意：x, y 为保留符号，不可定义
   - 图形表现：不绘制，但可能附带滑动条

3. **函数定义（Function Definition）**：
   - 形式：`f(x) = x^2`
   - 特点：定义一个函数并占用函数名
   - 图形表现：不绘制，但定义可在其他公式中使用

4. **临时函数（Temporary Function）**：
   - 形式：`x^2`、`sin(x)`、`y = g(x)`(g(x)已定义)、`V = (4/3)*pi*r^3`(V, r 未定义)
   - 特点：用于快速绘制函数图像而无需显式定义
   - 图形表现：根据不同形式和上下文绘制不同的图形

5. **方程/不等式（Equation/Inequality）**：
   - 形式：`x^2 + y^2 = 4`
   - 特点：关于x, y的方程/不等式
   - 图形表现：Desmos 会自动绘制其图像

6. **回归（Regression）**：
   - 形式：`Y ~ kX + b`
   - 特点：用于数据拟合，会自动计算参数值并引入新的变量定义
   - 图形表现：绘制拟合曲线

## 临时函数解析规则

临时函数是 Desmos 中一个特殊而强大的功能，它能自动识别和绘制多种形式的表达式。解析规则如下：

- **形如 `b = f(a)`，`y = f(a)` 和 `y = f(x)`**：
  - 绘制 y 轴为因变量的图像
  - a, b 为未定义的符号
  - 例：`y = sin(x)`、`y = a*x + b`

- **形如 `x = f(a)` 和 `x = f(y)`**：
  - 绘制 x 轴为因变量的图像
  - a 为未定义的符号
  - 例：`x = sin(y)`、`x = a*t`

- **形如 `f(x)`**：
  - 绘制 x 轴为自变量 / y 轴为因变量的图像
  - 表达式不得包含 x 以外的未定义符号
  - 例：`x^2`、`sin(x)`

## 符号系统

Desmos 公式系统中的符号有严格的规则：

1. **符号形式**：
   - 单个字符：如 `a`, `b`
   - 单个字符加下标：如 `a_{1}`, `b_{max}`
   - 下标可为多字符，但主字符只能是单个字符
   - 主字符范围包括大小写字母和希腊字母
   - 下标可以包括大小写字母和数字

> 补充说明：
> 在自建对象系统的设计中，无需担心用户输入下标等符号格式错误。Desmos 采用 Mathquill 作为所见即所得的数学公式编辑组件，用户在前端输入公式后，Mathquill 会将其转换为规范的 LaTeX 代码。Desmos 与 Mathquill 之间的数据交换也是基于 LaTeX 代码进行的，因此下标等语法结构在技术上是由 Mathquill 保证正确的。我们只需关注如何解析和建模这些规范的 LaTeX 公式即可，无需额外处理用户输入的语法错误。

2. **特殊符号**：
   - `x`, `y` 为保留符号，不可定义，用于临时函数和方程
   - 在 3D 计算器中，`z` 也是保留符号
   - `t` 与参数方程功能相关
   - 内置函数如 `sin`, `cos` 等是预定义的多字符符号

3. **符号类别**：
   - 已定义符号：用户显式定义的变量或函数
   - 未定义符号：尚未定义但在表达式中使用的符号
   - 内置符号：Desmos 预定义的符号，如 `sin`, `cos`, `e`, `π` 等
   - 保留符号：特殊用途的符号，如 `x`, `y`

4. **内置符号保护机制**：
   - 内置常数（如 `e`, `π`）不能被变量定义覆盖
   - 尝试定义 `e = 2` 会被解析为方程 `2.71828... = 2`，结果为不成立
   - 内置函数（如 `sin`, `cos`）不能被重新定义
   - 尝试定义 `sin(x) = 0.1x` 会被解析为关于 x 的方程，而非函数重定义
   - 命名空间分离：可以定义与内置符号同名的函数，如 `e(x) = x^2`，与常数 `e` 不冲突
   - 符号解析优先级：内置符号 > 用户定义符号，确保内置符号的语义不被破坏

## 符号计算能力观察

Desmos 展现出一定的符号计算能力，以下是一些观察现象：

1. **代换处理**：
   - 通过以下实验，观察到 Desmos 在符号代换和函数求值时的具体机制：

   **示例1：**
   ```
   c = a + b
   f(a, b) = c
   ```
   - `c = a + b` 报错（因为 a, b 未定义），但 `f(a, b) = c` 不报错
   - 推测：Desmos 将 `c` 代换为 `a + b`，形成 `f(a, b) = a + b`，成功解析为函数定义
   - `y = f(x, x)` 绘制为 y = 2x 的斜线图像。
   - 推测：在函数定义上下文中，Desmos能够进行符号代换，即使被代换的变量定义本身因依赖未定义符号而报错。函数调用时，f(x, x) = x + x = 2x

   **示例2：**
   ```
   c = a + b
   a = 2
   f(a, b) = c
   ```
   - `y = f(1, x)` 绘制为 y = 2 + x 的斜线图像。
   - `y = f(x, 1)` 绘制为 y = 3 的水平线图像。
   - 推测：当外部变量 a 已定义时，Desmos 在函数定义阶段就进行部分代换，将 c = a + b 中的 a 替换为 2，得到 c = 2 + b。因此函数实际上变成 f(a, b) = 2 + b。注意函数体中已定义的外部变量会直接代入其值，而函数参数保持符号形式

   **示例3：**
   ```
   c = a + b
   a = 2
   b = 1
   f(a, b) = c
   ```
   - 所有情况下 `y = f(..., ...)` 都绘制为 y = 3 的水平线图像。
   - 推测：当所有外部变量都已定义时，函数体中的表达式被完全求值为常数。c = 2 + 1 = 3，因此 f(a, b) = 3，无论传入什么参数都返回常数 3

   **机制总结：**
   - Desmos 在函数定义时会进行符号代换，将函数体中引用的外部变量替换为其定义
   - 代换过程中优先使用已定义变量的具体值，未定义变量保持符号形式
   - 函数参数与外部变量的作用域严格分离，函数体中的符号首先查找外部定义，然后才考虑函数参数
   - 这种机制使得 Desmos 能够实现灵活的符号计算和动态函数定义

2. **微积分处理**：
   - 观察：以下公式列表的行为：
     ```
     c = a + b           -> 报错: "变量太多。请尝试定义 a 和 b。"
     \frac{d}{da} c      -> 计算为: 1
     \frac{d}{db} c      -> 计算为: 1
     \frac{d}{dc} c      -> 计算为: 1
     \frac{d}{dc} a      -> 计算为: 0
     \frac{d}{dc} (a + b)-> 计算为: 0
     \frac{d}{dc} (2c)   -> 计算为: 2
     \frac{d}{dc} (2c^2) -> 报错: "变量太多。请尝试定义 a 和 b。"
     ```
   - 分析：微积分操作的图结构修改机制
     - 微分操作会创建新的表达式节点，如 `\frac{d}{dc} (2c^2)` 生成新节点 `4c`
     - 新生成的表达式仍然引用原有的符号节点，保持图结构的连通性
     - `\frac{d}{da} c` 成功：生成表达式 1，不包含未定义符号
     - `\frac{d}{dc} (2c^2)` 失败：生成表达式 `4c`，动态求值时发现 c 依赖未定义符号
   - 推测：微积分是少数会真正修改符号关系图结构的操作，其他计算主要依靠动态图遍历

3. **错误隔离**：
   - 观察：一处公式错误不一定导致依赖它的所有公式都错误
   - 推测：Desmos 公式系统具有一定的错误隔离能力，可能通过符号替换实现

## Desmos 解析流程模型

基于上述观察，我们推测 Desmos 的公式解析流程如下：

1. **语法解析**：
   - Desmos 从 Mathquill 模块接收公式 LaTeX 代码
   - 进行语法解析，识别表达式结构
   - 在分词步骤中，特定多字符符号（如内置函数）有更高的优先级
   - 除特定符号外，多字符组合默认视为乘法

2. **语义分析和局部符号表建立**：
   - 识别定义式：任何形如 `a = expression(b)` 的表达式都会被识别为定义式
   - 内置符号保护：检查定义式左边是否为内置符号，如果是则重新解析为方程
   - 识别公式类型：根据表达式结构初步确定公式类型（函数定义优先识别）
   - 建立全局符号表：记录所有全局定义的符号（变量、函数名等）及其关联表达式
   - 建立局部符号表：为函数等具有局部作用域的结构建立独立的局部符号表（如函数参数）
   - 此阶段不建立跨公式之间的联系

3. **跨公式依赖分析**：
   - 建立双向关联关系：
     - 符号表→公式列表：记录每个符号在哪个公式中被定义（第2步已建立）
     - 公式列表→符号表：记录每个公式引用了哪些符号（本步建立）
   - 作用域关系建立：确定函数参数与外部符号的作用域关系
   - 构建有向依赖图：在建立双向关联关系后，以公式为节点，符号引用关系为边，自然形成公式间的依赖图
   - 循环依赖检测：识别图中的强连通分量，标记循环依赖的公式节点
   - 依赖链分析：为每个符号建立完整的依赖链，用于动态求值时的图遍历
   - 建立符号解析优先级：内置符号 > 外部定义 > 函数参数

4. **动态计算和求值**：
   - 动态求值机制：通过图遍历进行计算，不进行预先的符号代换
   - 符号计算处理：处理微分、积分等操作，必要时修改图结构
   - 数值计算：对可求值的表达式进行数值计算

5. **类型确定和可视化**：
   - 根据计算结果重新确定公式类型（如临时函数识别）
   - 生成最终的可视化指令

## 图结构设计示例

为了更好地理解上述解析流程模型，我们通过一个复杂示例来说明统一图结构的构成：

**示例公式组合：**
```
a = 2
b = a + 1  
c = sin(b) * pi
f(x, y) = c + x^2 + y
g(t) = f(t, b)
```

**图结构详解：**
- **双表关系边**：
  - 符号a ←定义→ 公式1，符号b ←定义→ 公式2，符号c ←定义→ 公式3
  - 函数f ←定义→ 公式4，函数g ←定义→ 公式5
- **语法树边**（每个公式内部）：
  - 公式2：`+节点 → a引用节点，+节点 → 1节点`
  - 公式3：`*节点 → sin节点，*节点 → π节点；sin节点 → b引用节点`
  - 公式4：`+节点 → c引用节点，+节点 → ^节点，+节点 → y参数节点；^节点 → x参数节点，^节点 → 2节点`
  - 公式5：`f调用节点 → f引用节点，f调用节点 → t参数节点，f调用节点 → b引用节点`
- **衔接机制**：语法树中的引用节点（如a引用节点、f引用节点）通过符号表连接到对应的符号定义

这个统一图结构同时包含了跨公式依赖关系和公式内部结构，通过符号引用节点实现了两个层次的有机衔接。

**函数调用的特殊性：**

函数调用与变量定义在图结构上存在本质差异：
- **变量定义**：`a = 2` 建立确定的静态映射，a符号始终指向同一个值
- **函数调用**：`g(t) = f(t, b)` 中的f调用每次求值时都可能有不同的参数绑定

**调用上下文问题：**
- 同一函数 `f(x, y) = c + x^2 + y` 可能被多种方式调用：
  - `f(1, 2)` - 参数绑定为常数
  - `f(a, b)` - 参数绑定为其他符号
  - `f(t, t)` - 相同符号绑定到不同参数
- 每次调用都需要建立独立的参数绑定上下文，不能简单地用静态边表示

**可能的解决方案：**
- **调用节点模型**：为每个函数调用创建独立的调用节点，包含参数映射信息
- **动态绑定机制**：在求值时动态建立参数到实参的映射关系
- **上下文栈**：维护函数调用的嵌套上下文，支持递归和复杂调用链

**多通道节点架构（推荐方案）：**

核心思想：在静态图结构基础上，为每个节点添加多个"计算通道"，每个通道对应一个调用上下文。

- **静态层**：函数定义的语法树结构保持不变
  - `f(x, y) = c + x^2 + y` 的语法树结构是固定的
  - 节点关系和边连接不变

- **动态层**：每个节点维护多个通道
  - **通道标识**：每个函数调用分配唯一的上下文ID
  - **参数绑定通道**：参数节点x, y在不同通道中绑定不同值
  - **计算结果通道**：中间节点存储对应通道的计算结果

**示例：** `f(x, y) = x + y` 被多次调用时
```
f(1, 2)     → 通道1：x节点=1, y节点=2, +节点=3
f(a, b)     → 通道2：x节点=a值, y节点=b值, +节点=计算结果
f(t, t)     → 通道3：x节点=t值, y节点=t值, +节点=2*t值
```

**优势：**
- 静态图结构清晰，便于分析和优化
- 动态计算隔离，不同调用互不干扰
- 可缓存计算结果，提高效率
- 支持并发计算和调试

**挑战：**
- 通道生命周期管理
- 内存开销控制
- 循环引用和垃圾回收

## 公式属性系统

Desmos 为公式提供多种可设置的属性：

1. **绘图属性**：
   - 颜色：可设置为常量或表达式
   - 线宽：可设置为常量或表达式
   - 透明度：可设置为常量或表达式
   - 点样式：对于点集，可设置点的形状和大小
   - 线条样式：可设置为实线、虚线等

2. **滑动条属性**：
   - 最小值：可设置为常量或表达式
   - 最大值：可设置为常量或表达式
   - 步长：可设置为常量或表达式
   - 播放设置：包括速度、方向等

3. **属性行为**：
   - 属性保留：即使公式类型变化，属性也会被保留
   - 属性可用性：某些属性可能因公式类型变化而变为不可用，但值会被记住
   - 表达式属性：属性值可以是表达式，引用其他变量

## 公式列表特性

Desmos 中的公式列表具有以下特性：

1. **并列结构**：
   - 所有公式在逻辑上并列存在，不分先后顺序
   - 公式之间通过依赖关系隐式连接
   - 列表顺序影响图像的视觉层叠顺序

2. **动态行为**：
   - 用户编辑公式后图形计算器会动态响应，实时更新。
   - 用户可能引入的变动包括：
      - 公式内容的变化
      - 滑动条的拖动，以及播放的滑动条动画，引起对应变量值的变化
      - 动作的触发，引起对应变量值的变化
   - 图形计算器会根据用户编辑的变动，实时更新：
      - 公式类型可以随着编辑动态变化。
      - 依赖关系也随编辑实时更新。
      - 公式的可视化表现会根据类型和上下文自动调整。

3. **交互特性**：
   - 可折叠/展开公式组
   - 可临时隐藏公式（不影响依赖计算）
   - 可为公式添加注释

## 待研究问题

以下是关于Desmos公式系统尚未完全清晰的问题：

1. **符号解析的精确规则**：
   - 下标解析的完整规则
   - 多字符符号优先级的精确列表
   - 特殊符号处理（如希腊字母）的完整规则

2. **公式类型判定的精确算法**：
   - Desmos 如何精确区分不同公式类型
   - 歧义情况下的解析优先级
   - 临时函数和方程类型的详细判定规则

3. **符号计算能力的边界**：
   - 符号代换的精确行为和限制
   - 微积分操作的支持范围
   - 表达式简化的规则和程度

4. **符号计算机制的深层问题**：
   - **动态图遍历 vs 预先代换**：基于观察，Desmos可能主要采用动态图遍历进行计算，而非传统的符号代换
   - **函数调用的图结构挑战**：
     - **静态图 vs 动态上下文**：变量定义可用静态边表示，但函数调用需要动态上下文
     - **参数绑定复杂性**：同一函数的不同调用需要不同的参数绑定机制
     - **调用链管理**：如何在图结构中处理嵌套函数调用和递归调用
   - **统一图结构的设计挑战**：
     - **边方向一致性**：如何在跨公式依赖和语法树中保持统一的边方向约定
     - **图结构组成**：双表关系构成跨公式边，语法树构成公式内边，通过符号引用节点衔接
     - **双向遍历需求**：计算时需要正向遍历(依赖链)，变更传播时需要反向遍历
   - **图结构修改的边界**：
     - 大部分计算通过图遍历完成，不修改原始图结构
     - 微分等操作会创建新节点，真正修改图结构
     - 用户编辑公式时会更新图结构
   - **错误检测时机**：错误可能在动态求值过程中检测，而非预先检查
   - **数据结构优化**：如何高效存储和遍历符号关系图，避免重复计算
   - **关键问题**：如何在统一图结构中优雅地处理函数调用的动态特性？静态图结构是否足够表达所有计算需求？

> 本文档将随着研究进展持续更新，欢迎补充新的观察和推测。 