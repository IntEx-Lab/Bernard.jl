# Desmos 公式系统建模

本文档详细描述对 Desmos 公式系统的建模研究。由于 Desmos 并未开源，这些建模基于观察和推测，旨在为 ExprBuild 项目提供准确的设计基础。

## 基本术语定义

在 ExprBuild 中，我们对 Desmos 相关术语做出以下区分：

- **公式（Formula）**：指 Desmos 中的一行可编辑内容，包括变量定义、函数定义、方程等各种类型。Desmos 官方称之为"表达式"（Expression），但我们采用"公式"这一更广义的术语。

- **表达式（Expression）**：指可求值的数学表达式，是公式的一个子类型。

- **Expr**：在文档和代码里尽量用这个缩写来指代Julia语言的表达式概念，方便讨论和使用Julia语言的宏和元编程能力。

## 公式类型系统

Desmos 支持以下几种主要公式类型：

1. **表达式（Expression）**：
   - 形式：`2 + a`（其中 a 为已定义变量）
   - 特点：可以求值，但不定义任何新符号
   - 图形表现：不绘制任何图形，仅显示计算结果

2. **变量定义（Variable Definition）**：
   - 形式：`a = 3`
   - 特点：定义一个变量并占用该符号
   - 注意：x, y 为保留符号，不可定义
   - 图形表现：不绘制，但可能附带滑动条

3. **函数定义（Function Definition）**：
   - 形式：`f(x) = x^2`
   - 特点：定义一个函数并占用函数名
   - 图形表现：不绘制，但定义可在其他公式中使用

4. **临时函数（Temporary Function）**：
   - 形式：`x^2`、`sin(x)`、`y = g(x)`(g(x)已定义)、`V = (4/3)*pi*r^3`(V, r 未定义)
   - 特点：用于快速绘制函数图像而无需显式定义
   - 图形表现：根据不同形式和上下文绘制不同的图形

5. **方程/不等式（Equation/Inequality）**：
   - 形式：`x^2 + y^2 = 4`
   - 特点：关于x, y的方程/不等式
   - 图形表现：Desmos 会自动绘制其图像

6. **回归（Regression）**：
   - 形式：`Y ~ kX + b`
   - 特点：用于数据拟合，会自动计算参数值并引入新的变量定义
   - 图形表现：绘制拟合曲线

## 临时函数解析规则

临时函数是 Desmos 中一个特殊而强大的功能，它能自动识别和绘制多种形式的表达式。解析规则如下：

- **形如 `b = f(a)`，`y = f(a)` 和 `y = f(x)`**：
  - 绘制 y 轴为因变量的图像
  - a, b 为未定义的符号
  - 例：`y = sin(x)`、`y = a*x + b`

- **形如 `x = f(a)` 和 `x = f(y)`**：
  - 绘制 x 轴为因变量的图像
  - a 为未定义的符号
  - 例：`x = sin(y)`、`x = a*t`

- **形如 `f(x)`**：
  - 绘制 x 轴为自变量 / y 轴为因变量的图像
  - 表达式不得包含 x 以外的未定义符号
  - 例：`x^2`、`sin(x)`

## 符号系统

Desmos 公式系统中的符号有严格的规则：

1. **符号形式**：
   - 单个字符：如 `a`, `b`
   - 单个字符加下标：如 `a_{1}`, `b_{max}`
   - 下标可为多字符，但主字符只能是单个字符
   - 主字符范围包括大小写字母和希腊字母
   - 下标可以包括大小写字母和数字

2. **特殊符号**：
   - `x`, `y` 为保留符号，不可定义，用于临时函数和方程
   - 在 3D 计算器中，`z` 也是保留符号
   - `t` 与参数方程功能相关
   - 内置函数如 `sin`, `cos` 等是预定义的多字符符号

3. **符号类别**：
   - 已定义符号：用户显式定义的变量或函数
   - 未定义符号：尚未定义但在表达式中使用的符号
   - 内置符号：Desmos 预定义的符号，如 `sin`, `pi` 等
   - 保留符号：特殊用途的符号，如 `x`, `y`

## Desmos 解析流程模型

我们推测 Desmos 的公式解析流程如下：

1. **语法解析**：
   - Desmos 从 Mathquill 模块接收公式 LaTeX 代码
   - 进行语法解析，识别表达式结构
   - 在分词步骤中，特定多字符符号（如内置函数）有更高的优先级
   - 除特定符号外，多字符组合默认视为乘法

2. **语义分析**：
   - 识别定义式：任何形如 `a = expression(b)` 的表达式都会被识别为定义式
   - 建立符号表：记录所有定义的符号及其关联表达式
   - 识别公式类型：根据表达式结构和符号上下文确定公式类型

3. **依赖分析**：
   - 构建依赖图：表达式中引用的每个符号都建立依赖关系
   - 检查循环依赖：确保没有循环引用
   - 验证符号可用性：检查表达式中的所有符号是否都已定义或为内置符号

4. **符号计算处理**：
   - 表达式代换：在需要时进行符号代换，如将变量替换为其定义表达式
   - 派生计算：处理微积分操作，如导数、积分
   - 符号简化：可能进行一定的表达式简化

## 符号计算能力观察

Desmos 展现出一定的符号计算能力，以下是一些观察现象：

1. **代换处理**：
   - 观察：`c = a + b; f(a, b) = c` 中，`c = a + b` 报错（因为 a, b 未定义），但 `f(a, b) = c` 不报错
   - 推测：Desmos 将 `c` 代换为 `a + b`，形成 `f(a, b) = a + b`，成功解析为函数定义

2. **微积分处理**：
   - 观察：以下公式列表的行为：
     ```
     c = a + b           -> 报错: "变量太多。请尝试定义 a 和 b。"
     \frac{d}{da} c      -> 计算为: 1
     \frac{d}{db} c      -> 计算为: 1
     \frac{d}{dc} c      -> 计算为: 1
     \frac{d}{dc} a      -> 计算为: 0
     \frac{d}{dc} (a + b)-> 计算为: 0
     \frac{d}{dc} (2c)   -> 计算为: 2
     \frac{d}{dc} (2c^2) -> 报错: "变量太多。请尝试定义 a 和 b。"
     ```
   - 推测：Desmos 能进行基本的符号微分计算，但能力有限

3. **错误隔离**：
   - 观察：一处公式错误不一定导致依赖它的所有公式都错误
   - 推测：Desmos 公式系统具有一定的错误隔离能力，可能通过符号替换实现

## 公式属性系统

Desmos 为公式提供多种可设置的属性：

1. **绘图属性**：
   - 颜色：可设置为常量或表达式
   - 线宽：可设置为常量或表达式
   - 透明度：可设置为常量或表达式
   - 点样式：对于点集，可设置点的形状和大小
   - 线条样式：可设置为实线、虚线等

2. **滑动条属性**：
   - 最小值：可设置为常量或表达式
   - 最大值：可设置为常量或表达式
   - 步长：可设置为常量或表达式
   - 播放设置：包括速度、方向等

3. **属性行为**：
   - 属性保留：即使公式类型变化，属性也会被保留
   - 属性可用性：某些属性可能因公式类型变化而变为不可用，但值会被记住
   - 表达式属性：属性值可以是表达式，引用其他变量

## 公式列表特性

Desmos 中的公式列表具有以下特性：

1. **并列结构**：
   - 所有公式在逻辑上并列存在，不分先后顺序
   - 公式之间通过依赖关系隐式连接
   - 列表顺序影响图像的视觉层叠顺序

2. **动态行为**：
   - 公式类型可以随着编辑动态变化
   - 依赖关系也随编辑实时更新
   - 公式的可视化表现会根据类型和上下文自动调整

3. **交互特性**：
   - 可折叠/展开公式组
   - 可临时隐藏公式（不影响依赖计算）
   - 可为公式添加注释

## 待研究问题

以下是关于Desmos公式系统尚未完全清晰的问题：

1. **符号解析的精确规则**：
   - 下标解析的完整规则
   - 多字符符号优先级的精确列表
   - 特殊符号处理（如希腊字母）的完整规则

2. **公式类型判定的精确算法**：
   - Desmos 如何精确区分不同公式类型
   - 歧义情况下的解析优先级
   - 临时函数和方程类型的详细判定规则

3. **符号计算能力的边界**：
   - 符号代换的精确行为和限制
   - 微积分操作的支持范围
   - 表达式简化的规则和程度

> 本文档将随着研究进展持续更新，欢迎补充新的观察和推测。 